# 123云盘开放平台上传流程说明

本文档详细说明了通过123云盘开放平台API上传文件的两种方式：分片上传和单步上传。

---

## 一、分片上传

分片上传适用于大文件，最大支持10GB。该流程将文件分成多个片段进行上传，提高了大文件上传的稳定性和可靠性。

### **流程概述**

1.  **创建文件**：调用创建文件接口，通知服务器即将开始上传。服务器会返回`preuploadID`和分片大小`sliceSize`。如果服务器已有相同文件，将直接秒传成功。
2.  **上传分片**：根据返回的`sliceSize`将文件切片，并为每个分片计算MD5。然后逐个调用上传分片接口，将所有分片上传至服务器。
3.  **上传完毕**：所有分片上传成功后，调用上传完毕接口，通知服务器合并文件。

### **时序图**

```mermaid
sequenceDiagram
    participant Client as 客户端
    participant Server as 服务器
    Client->>Server: 1. 调用创建文件接口 (携带文件基本信息)
    alt 秒传成功 (reuse: true)
        Server-->>Client: 返回 fileID，上传结束
    else 非秒传 (reuse: false)
        Server-->>Client: 返回 preuploadID, sliceSize, 上传域名(servers)
        Client->>Client: 2. 根据 sliceSize 切分文件，计算各分片MD5
        loop 遍历所有文件分片
            Client->>Server: 3. 调用上传分片接口 (携带preuploadID, 分片序号, 分片MD5, 分片数据)
            Server-->>Client: 响应上传结果
        end
        Client->>Server: 4. 调用上传完毕接口 (携带preuploadID)
        loop completed 为 false
            Server-->>Client: 返回 completed: false
            Client->>Client: 间隔1秒后重试
            Client->>Server: 再次调用上传完毕接口
        end
        Server-->>Client: 返回 completed: true, fileID，上传完成
    end

```

---

### **步骤一：创建文件**

**API:** `POST {域名}/upload/v2/file/create`

**说明:**
*   文件名要小于256个字符且不能包含以下任何字符：`"\/
:*?|><`
*   文件名不能全部是空格。
*   开发者上传单文件大小限制10GB。

#### **Header 参数**

| 名称 | 类型 | 是否必填 | 说明 |
| :--- | :--- | :--- | :--- |
| `Authorization` | string | 必填 | 鉴权 access\_token |
| `Platform` | string | 必填 | 固定为: `open_platform` |

#### **Body 参数**

| 名称 | 类型 | 是否必填 | 说明 |
| :--- | :--- | :--- | :--- |
| `parentFileID` | number | 必填 | 父目录id，上传到根目录时填写 `0` |
| `filename` | string | 必填 | 文件名（注：不能重名）。`containDir` 为 true 时，传入路径+文件名，例如：`/你好/123/测试文件.mp4` |
| `etag` | string | 必填 | 文件md5 |
| `size` | number | 必填 | 文件大小，单位为 byte 字节 |
| `duplicate` | number | 非必填 | 当有相同文件名时，文件处理策略（1:保留两者，新文件名将自动添加后缀，2:覆盖原文件） |
| `containDir` | bool | 非必填 | 上传文件是否包含路径，默认 `false` |

#### **返回数据**

| 名称 | 类型 | 是否必填 | 说明 |
| :--- | :--- | :--- | :--- |
| `fileID` | number | 非必填 | 文件ID。当123云盘已有该文件,则会发生秒传。此时会将文件ID字段返回。 |
| `preuploadID` | string | 必填 | 预上传ID (如果 `reuse` 为 `true` 时,该字段不存在) |
| `reuse` | boolean | 必填 | 是否秒传，返回 `true` 时表示文件已上传成功 |
| `sliceSize` | number | 必填 | 分片大小，必须按此大小生成文件分片再上传 |
| `servers` | array | 必填 | 上传地址域名，多个任选其一 |

#### **示例**

<details>
<summary><b>请求示例 (NodeJs - Axios)</b></summary>

```javascript
const axios = require('axios');
let data = JSON.stringify({
  "parentFileID": 0,
  "filename": "测试文件.mp4",
  "etag": "4b5c549c4abd0a079caf92d6cad24127",
  "size": 50650928
});

let config = {
  method: 'post',
  maxBodyLength: Infinity,
  url: 'https://open-api.123pan.com/upload/v2/file/create',
  headers: {
    'Content-Type': 'application/json',
    'Platform': 'open_platform',
    'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJl...(过长省略)'
  },
  data : data
};

axios.request(config)
.then((response) => {
  console.log(JSON.stringify(response.data));
})
.catch((error) => {
  console.log(error);
});
```

</details>

<details>
<summary><b>请求示例 (Python - http.client)</b></summary>

```python
import http.client
import json

conn = http.client.HTTPSConnection("open-api.123pan.com")
payload = json.dumps({
    "parentFileID": 0,
    "filename": "测试文件.mp4",
    "etag": "4b5c549c4abd0a079caf92d6cad24127",
    "size": 50650928
})
headers = {
    'Content-Type': 'application/json',
    'Platform': 'open_platform',
    'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJl...(过长省略)'
}
conn.request("POST", "/upload/v2/file/create", payload, headers)
res = conn.getresponse()
data = res.read()
print(data.decode("utf-8"))
```

</details>

<details>
<summary><b>响应示例 (JSON)</b></summary>

```json
{
  "code": 0,
  "message": "ok",
  "data": {
    "fileID": 0,
    "reuse": false,
    "preuploadID": "WvjyUgonimrlBq2PVJ3bSyjPVJYP4IGeSxGdSly...(过长省略)",
    "sliceSize": 16777216,
    "servers": [
      "http://openapi-upload.123242.com"
    ]
  },
  "x-traceID": "2f41bbb4-93ab-459b-8dab-2204d3b3ff66_kong-db-5898fdd8c6-wnv6h"
}
```

</details>

---

### **步骤二：上传分片**

**API:** `POST {上传域名}/upload/v2/file/slice`

**说明:**
*   上传域名是 **创建文件** 接口响应中的 `servers` 字段。
*   `Content-Type` 必须为 `multipart/form-data`。

#### **Header 参数**

| 名称 | 类型 | 是否必填 | 说明 |
| :--- | :--- | :--- | :--- |
| `Authorization` | string | 必填 | 鉴权 access\_token |
| `Platform` | string | 必填 | 固定为: `open_platform` |

#### **Body 参数 (multipart/form-data)**

| 名称 | 类型 | 是否必填 | 说明 |
| :--- | :--- | :--- | :--- |
| `preuploadID` | string | 必填 | 预上传ID |
| `sliceNo` | number | 必填 | 分片序号，从 `1` 开始自增 |
| `sliceMD5` | string | 必填 | 当前分片的md5 |
| `slice` | file | 必填 | 分片二进制流 |

#### **返回数据**
无。请求成功即表示该分片上传成功。

#### **示例**

<details>
<summary><b>请求示例 (Python - http.client)</b></summary>

```python
import http.client
import mimetypes
from codecs import encode

conn = http.client.HTTPConnection("openapi-upload-dev.123242.com") # 使用创建文件接口返回的域名
dataList = []
boundary = 'wL36Yn8afVp8Ag7AmP8qZ0SA4n1v9T'
# --- preuploadID ---
dataList.append(encode('--' + boundary))
dataList.append(encode('Content-Disposition: form-data; name="preuploadID";'))
dataList.append(encode('Content-Type: {}'.format('text/plain')))
dataList.append(encode(''))
dataList.append(encode("WvjyUgonimrlI4sjB3sLG5sRBn3x43..."))

# --- sliceNo ---
dataList.append(encode('--' + boundary))
dataList.append(encode('Content-Disposition: form-data; name="sliceNo";'))
dataList.append(encode('Content-Type: {}'.format('text/plain')))
dataList.append(encode(''))
dataList.append(encode("1"))

# --- sliceMD5 ---
dataList.append(encode('--' + boundary))
dataList.append(encode('Content-Disposition: form-data; name="sliceMD5";'))
dataList.append(encode('Content-Type: {}'.format('text/plain')))
dataList.append(encode(''))
dataList.append(encode("58f06dd588d8ffb3beb46ada6309436b"))

# --- slice file ---
dataList.append(encode('--' + boundary))
filepath = '/D:/新建 文本文档 (4).txt'
filename = '新建 文本文档 (4).txt'
dataList.append(encode(f'Content-Disposition: form-data; name="slice"; filename="{filename}"'))
fileType = mimetypes.guess_type(filepath) or 'application/octet-stream'
dataList.append(encode('Content-Type: {}'.format(fileType)))
dataList.append(encode(''))

with open(filepath, 'rb') as f:
  dataList.append(f.read())

# --- 结束 ---
dataList.append(encode('--'+boundary+'--'))
dataList.append(encode(''))
body = b'\r\n'.join(dataList)

headers = {
  'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5c...(过长省略)',
  'Platform': 'open_platform',
  'Content-type': f'multipart/form-data; boundary={boundary}'
}

conn.request("POST", "/upload/v2/file/slice", body, headers)
res = conn.getresponse()
data = res.read()
print(data.decode("utf-8"))
```
</details>

<details>
<summary><b>响应示例 (JSON)</b></summary>

```json
{
    "code": 0,
    "message": "ok",
    "data": null,
    "x-traceID": ""
}
```
</details>

---

### **步骤三：上传完毕**

**API:** `POST {域名}/upload/v2/file/upload_complete`

**说明:** 所有分片上传完成后，调用此接口通知服务器进行文件合并。

#### **Header 参数**

| 名称 | 类型 | 是否必填 | 说明 |
| :--- | :--- | :--- | :--- |
| `Authorization` | string | 必填 | 鉴权 access\_token |
| `Platform` | string | 必填 | 固定为: `open_platform` |

#### **Body 参数**

| 名称 | 类型 | 是否必填 | 说明 |
| :--- | :--- | :--- | :--- |
| `preuploadID` | string | 必填 | 预上传ID |

#### **返回数据**

| 名称 | 类型 | 是否必填 | 说明 |
| :--- | :--- | :--- | :--- |
| `completed` | bool | 必填 | 上传是否完成。若为 `false`，则需间隔1秒继续轮询此接口。 |
| `fileID` | number | 必填 | 上传完成后的文件ID。 |

#### **示例**

<details>
<summary><b>请求示例 (NodeJs - Axios)</b></summary>

```javascript
const axios = require('axios');
let data = JSON.stringify({
  "preuploadID": "WvjyUgonimrlI4sjB3sLG5sRBn3x43VRBx2dB...(过长省略)"
});

let config = {
  method: 'post',
  maxBodyLength: Infinity,
  url: 'https://open-api.123pan.com/upload/v2/file/upload_complete',
  headers: {
    'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5c...(过长省略)',
    'Platform': 'open_platform',
    'Content-Type': 'application/json'
  },
  data : data
};

axios.request(config)
.then((response) => {
  console.log(JSON.stringify(response.data));
})
.catch((error) => {
  console.log(error);
});
```
</details>

<details>
<summary><b>请求示例 (Python - http.client)</b></summary>

```python
import http.client
import json

conn = http.client.HTTPSConnection("open-api.123pan.com")
payload = json.dumps({
  "preuploadID": "WvjyUgonimrlI4sjB3sLG5sRBn3x43VRBx2dB...(过长省略)"
})
headers = {
  'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5c...(过长省略)',
  'Platform': 'open_platform',
  'Content-Type': 'application/json'
}
conn.request("POST", "/upload/v2/file/upload_complete", payload, headers)
res = conn.getresponse()
data = res.read()
print(data.decode("utf-8"))
```
</details>

<details>
<summary><b>响应示例 (JSON)</b></summary>

```json
{
    "code": 0,
    "message": "ok",
    "data": {
        "completed": true,
        "fileID": 11522654
    },
    "x-traceID": "65562117-5c67-4d69-98cb-0f65201f83d3_test-kong-7787db5b5-wggzb"
}
```
</details>

---
---

## 二、单步上传

单步上传适用于小文件，最大支持1GB。通过一次HTTP请求即可完成文件上传，流程更简单。

### **流程概述**

1.  **获取上传域名**：调用接口获取专用的上传域名。
2.  **发起上传**：计算文件MD5，然后调用单步上传接口，在一次请求中提交所有文件信息和文件二进制流。

### **步骤一：获取上传域名**

**API:** `GET {域名}/upload/v2/file/domain`

#### **Header 参数**

| 名称 | 类型 | 是否必填 | 说明 |
| :--- | :--- | :--- | :--- |
| `Authorization` | string | 必填 | 鉴权 access\_token |
| `Platform` | string | 必填 | 固定为: `open_platform` |

#### **Body 参数**
无

#### **返回数据**

| 名称 | 类型 | 是否必填 | 说明 |
| :--- | :--- | :--- | :--- |
| `data` | array | 必填 | 上传域名列表，存在多个可以任选其一 |

#### **示例**

<details>
<summary><b>请求示例 (NodeJs - Axios)</b></summary>

```javascript
const axios = require('axios');

let config = {
  method: 'get',
  maxBodyLength: Infinity,
  url: 'https://open-api.123pan.com/upload/v2/file/domain',
  headers: {
    'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5c...(过长省略)',
    'Platform': 'open_platform'
  }
};

axios.request(config)
.then((response) => {
  console.log(JSON.stringify(response.data));
})
.catch((error) => {
  console.log(error);
});
```
</details>

<details>
<summary><b>请求示例 (Python - http.client)</b></summary>

```python
import http.client

conn = http.client.HTTPSConnection("open-api.123pan.com")
payload = ''
headers = {
  'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5c...(过长省略)',
  'Platform': 'open_platform'
}
conn.request("GET", "/upload/v2/file/domain", payload, headers)
res = conn.getresponse()
data = res.read()
print(data.decode("utf-8"))
```
</details>

<details>
<summary><b>响应示例 (JSON)</b></summary>

```json
{
    "code": 0,
    "message": "ok",
    "data": [
        "https://openapi-upload.123pan.com"
    ],
    "x-traceID": ""
}
```
</details>

---

### **步骤二：发起上传**

**API:** `POST {上传域名}/upload/v2/file/single/create`

**说明:**
*   上传域名是 **获取上传域名** 接口响应中的域名。
*   `Content-Type` 必须为 `multipart/form-data`。
*   文件名要小于256个字符且不能包含以下任何字符：`"\/
:*?|><`
*   文件名不能全部是空格。
*   此接口限制开发者上传单文件大小为1GB。

#### **Header 参数**

| 名称 | 类型 | 是否必填 | 说明 |
| :--- | :--- | :--- | :--- |
| `Authorization` | string | 必填 | 鉴权 access\_token |
| `Platform` | string | 必填 | 固定为: `open_platform` |

#### **Body 参数 (multipart/form-data)**

| 名称 | 类型 | 是否必填 | 说明 |
| :--- | :--- | :--- | :--- |
| `parentFileID` | number | 必填 | 父目录id，上传到根目录时填写 `0` |
| `filename` | string | 必填 | 文件名。`containDir` 为 `true` 时，传入路径+文件名，例如：`/你好/123/测试文件.mp4` |
| `etag` | string | 必填 | 文件md5 |
| `size` | number | 必填 | 文件大小，单位为 byte 字节 |
| `file` | file | 必填 | 文件二进制流 |
| `duplicate` | number | 非必填 | 当有相同文件名时，文件处理策略（1:保留两者，新文件名将自动添加后缀，2:覆盖原文件） |
| `containDir` | bool | 非必填 | 上传文件是否包含路径，默认 `false` |

#### **返回数据**

| 名称 | 类型 | 是否必填 | 说明 |
| :--- | :--- | :--- | :--- |
| `fileID` | number | 必填 | 文件ID。当123云盘已有该文件,则会发生秒传。 |
| `completed` | bool | 必填 | 是否上传完成。返回 `true` 即表示上传成功。 |

#### **示例**

<details>
<summary><b>请求示例 (Python - http.client)</b></summary>

```python
import http.client
import mimetypes
from codecs import encode
import uuid

conn = http.client.HTTPSConnection("openapi-upload.123242.com") # 使用获取的上传域名
dataList = []
boundary = '----FormBoundary-' + uuid.uuid4().hex # 使用随机的boundary

# --- file ---
dataList.append(encode('--' + boundary))
filepath = 'C:/Users/Administrator/Desktop/test_py/abc.pdf'
filename = 'abc.pdf'
dataList.append(encode(f'Content-Disposition: form-data; name="file"; filename="{filename}"'))
fileType = mimetypes.guess_type(filepath) or 'application/octet-stream'
dataList.append(encode('Content-Type: ' + fileType))
dataList.append(encode(''))

with open(filepath, 'rb') as f:
    dataList.append(f.read())

# --- parentFileID ---
dataList.append(encode('--' + boundary))
dataList.append(encode('Content-Disposition: form-data; name="parentFileID"'))
dataList.append(encode('Content-Type: text/plain'))
dataList.append(encode(''))
dataList.append(encode("19412058"))

# --- filename ---
dataList.append(encode('--' + boundary))
dataList.append(encode('Content-Disposition: form-data; name="filename"'))
dataList.append(encode('Content-Type: text/plain'))
dataList.append(encode(''))
dataList.append(encode("abc.pdf"))

# --- etag ---
dataList.append(encode('--' + boundary))
dataList.append(encode('Content-Disposition: form-data; name="etag"'))
dataList.append(encode('Content-Type: text/plain'))
dataList.append(encode(''))
dataList.append(encode("7a2c650b006a9b800edd11ab3d2d1161"))

# --- size ---
dataList.append(encode('--' + boundary))
dataList.append(encode('Content-Disposition: form-data; name="size"'))
dataList.append(encode('Content-Type: text/plain'))
dataList.append(encode(''))
dataList.append(encode("3901780"))

# --- 结束 ---
dataList.append(encode('--' + boundary + '--'))
dataList.append(encode(''))

body = b'\r\n'.join(dataList)

headers = {
  'Authorization': 'Bearer eyJhbGciOiJIUzI1...(过长省略)',
  'Platform': 'open_platform',
  'Content-type': f'multipart/form-data; boundary={boundary}'
}
conn.request("POST", "/upload/v2/file/single/create", body, headers)
res = conn.getresponse()
data = res.read()
print(data.decode("utf-8"))
```

</details>

<details>
<summary><b>响应示例 (JSON)</b></summary>

```json
{
    "code": 0,
    "message": "ok",
    "data": {
        "fileID": 11522653,
        "completed": true
    },
    "x-traceID": ""
}
```
</details>

```
